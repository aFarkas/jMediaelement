(function(e){var t='<button class="{%class%}"><span class="jme-icon"></span><span class="jme-text">{%text%}</span></button>',n="pseudoClasses";e.jme.ButtonMenu=function(t,n,i){this.button=e(t).attr({"aria-haspopup":"true"}),this.clickHandler=i,this.toggle=e.proxy(this,"toggle"),this.keyIndex=e.proxy(this,"keyIndex"),this._buttonClick=e.proxy(this,"_buttonClick"),this.addMenu(n),this._closeFocusOut(),this.button.bind("click",this.toggle)},e.jme.ButtonMenu.prototype={addMenu:function(t){this.menu&&this.menu.remove(),this.menu=e(t),this.buttons=e("button",this.menu),this.menu.insertAfter(this.button),this.menu.bind("keydown",this.keyIndex).delegate("button","click",this._buttonClick)},_closeFocusOut:function(){var e,t=this,n=function(){clearTimeout(e),setTimeout(function(){clearTimeout(e)},9)};this.menu.parent().bind("focusin",n).bind("mousedown",n).bind("focusout",function(){e=setTimeout(function(){t.hide()},40)})},_buttonClick:function(e){this.clickHandler(this.buttons.index(e.currentTarget),e.currentTarget),this.hide()},keyIndex:function(e){var t=40==e.keyCode?1:38==e.keyCode?-1:0;if(t){var n=this.buttons.not(":disabled"),i=n.filter(":focus");i=n[n.index(i)+t]||n.filter(t>0?":first":":last"),i.focus(),e.preventDefault()}},show:function(){if(!this.isVisible){var t=this.buttons.not(":disabled");this.isVisible=!0,this.menu.addClass("visible-menu");try{this.activeElement=document.activeElement||this.button[0]}catch(n){this.activeElement=this.button[0]}setTimeout(function(){e(t.filter('[aria-checked="true"]')[0]||t[0]).focus()},60)}},toggle:function(){this[this.isVisible?"hide":"show"]()},hide:function(){if(this.isVisible){if(this.isVisible=!1,this.menu.removeClass("visible-menu"),this.activeElement)try{this.activeElement.focus()}catch(e){}this.activeElement=!1}}};var i={subtitles:1,caption:1},a=function(t){var n=e.map(t,function(e){var t="caption"==e.kind?"caption-type":"subtitle-type",n=e.language;return n=n?' <span class="track-lang">'+n+"</span>":"",'<li class="'+t+'" role="presentation"><button role="menuitemcheckbox">'+e.label+n+"</button></li>"});return"<div><ul>"+n.join("")+"</ul></div>"};e.jme.registerPlugin("captions",{pseudoClasses:{enabled:"state-captionsenabled",disabled:"state-captionsdisabled",noTrack:"no-track",hasTrack:"has-track",menu:"subtitle-menu"},structure:t,text:"subtitles menu",_create:function(t,r,s){var o=this,l=r.find("track"),u=e("span.jme-text, +label span.jme-text",t);u[0]||(u=t),u.html(o.text),l.length?s.addClass(o[n].hasTrack):(t.prop("disabled",!0),s.addClass(o[n].noTrack)),e.webshims.ready("track",function(){function l(n){d?d.addMenu(n):d=new e.jme.ButtonMenu(t,n,function(t,n){"true"==e.attr(n,"aria-checked")?m[t].mode="disabled":e.each(m,function(e,n){n.mode=e==t?"showing":"disabled"}),r.prop("textTracks"),u()}),u()}function u(){e("button",d.menu).each(function(t){e.attr(this,"aria-checked","showing"==m[t].mode?"true":"false")})}function c(){m=[],e.each(p,function(e,t){i[t.kind]&&3!=t.readyState&&m.push(t)}),m.length?(l('<div class="'+o[n].menu+'" >'+a(m)+"</div>"),(!s.hasClass(o[n].hasTrack)||s.hasClass(o[n].noTrack))&&(t.prop("disabled",!1),s.addClass(o[n].hasTrack).removeClass(o[n].noTrack).triggerHandler("controlschanged"))):(!s.hasClass(o[n].noTrack)||s.hasClass(o[n].hasTrack))&&(t.prop("disabled",!0),s.addClass(o[n].noTrack).removeClass(o[n].hasTrack).triggerHandler("controlschanged"))}var d,m=[],p=r.prop("textTracks"),f=function(){var e,t;return function(n){clearTimeout(e),clearTimeout(t),"updatesubtitlestate"==n.type&&(t=setTimeout(function(){r.trigger("updatetracklist")},0)),e=setTimeout(c,19)}}();p?(c(),e([p]).on("addtrack removetrack",f),s.bind("updatesubtitlestate",f),r.bind("updatetrackdisplay",function(){var e;return function(){clearTimeout(e),e=setTimeout(u,20)}}())):(p=[],c())})}})})(jQuery);